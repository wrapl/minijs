<?xml version="1.0" encoding="UTF-8" ?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
</head>
<body style="font-family:monospace;">
<textarea id="input" style="width:100%;height:300px;"/>
<br/>
<button id="compile">Compile</button>
<br/>
<div id="compiled"/>
<button id="execute">Execute</button>
<br/>
<pre id="console"/>
<div id="output"/>
<script type="module">
import { Globals, ml_call, ml_resume, ml_decode, MLNil, MLStringT } from './minilang.js';

let inputElement = document.getElementById("input");
let bytecodeElement = document.getElementById("compiled");
let consoleElement = document.getElementById("console");
let outputElement = document.getElementById("output");
let compileElement = document.getElementById("compile");
let executeElement = document.getElementById("execute");

Globals.print = function(caller, args) {
	if (args.length === 0) return ml_resume(caller, MLNil);
	let state = {caller, index: 1, run: function(self, value) {
		consoleElement.appendChild(document.createTextNode(value.toString()));
		if (self.index === args.length) return ml_resume(self.caller, MLNil);
		ml_call(self, MLStringT.of, [args[self.index++]]);
	}};
	ml_call(state, MLStringT.of, [args[0]]);
}

compileElement.onclick = function() {
	let request = new XMLHttpRequest();	
	request.onreadystatechange = function() {
		if (request.readyState === XMLHttpRequest.DONE) {
			if (request.status === 200) {
				let json = request.responseText;
				bytecodeElement.textContent = json;
				window.main = ml_decode(JSON.parse(json), []);
			}
		}
	}
	bytecodeElement.textContext = "";
	request.open('POST', '/compile');
	request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	request.send('input=' + encodeURIComponent(input.value));
}

executeElement.onclick = function() {
	consoleElement.textContent = "";
	ml_call(null, window.main, []);
}
</script>
</body>
</html>
